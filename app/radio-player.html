<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Radio Player</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Radio">
    <link rel="apple-touch-icon" href="./assets/icons/icon-192.png">

    <!-- Theme Colors -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="msapplication-TileColor" content="#2c3e50">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
            transition: background 0.6s ease;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            height: -webkit-fill-available;
        }

        /* Default/Neutral theme */
        body.no-selection {
            background: linear-gradient(135deg, #0f3460 0%, #1a1f3a 50%, #16213e 100%);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: rgba(139, 76, 246, 0.2);
        }

        /* Classic FM Theme */
        body.theme-classicfm {
            background: linear-gradient(135deg, #0a0000 0%, #1a0000 30%, #2a0505 70%, #0a0000 100%);
            --text-primary: #ffffff;
            --text-secondary: #FFD700;
            --border-color: rgba(255, 215, 0, 0.3);
        }

        /* Reprezent Theme */
        body.theme-reprezent {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 30%, #0f0f0f 70%, #050505 100%);
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: rgba(255, 255, 255, 0.3);
        }

        .player-container {
            background: rgba(15, 52, 96, 0.85);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 32px;
            padding: 48px;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px var(--border-color),
                0 0 80px rgba(139, 76, 246, 0.5),
                0 0 160px rgba(139, 76, 246, 0.4),
                0 0 240px rgba(139, 76, 246, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            max-width: 700px;
            width: 100%;
            transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                        border 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
            border: 1px solid var(--border-color);
        }

        body.theme-classicfm .player-container {
            background: rgba(42, 5, 5, 0.95);
            box-shadow:
                0 30px 90px rgba(220, 20, 60, 0.4),
                0 0 0 1px rgba(255, 215, 0, 0.3),
                0 0 80px rgba(220, 20, 60, 0.45),
                0 0 160px rgba(255, 215, 0, 0.35),
                0 0 240px rgba(220, 20, 60, 0.25),
                inset 0 1px 0 rgba(255, 215, 0, 0.1);
        }

        body.theme-reprezent .player-container {
            background: rgba(31, 30, 30, 0.95);
            box-shadow:
                0 30px 90px rgba(255, 255, 255, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.3),
                0 0 80px rgba(255, 255, 255, 0.4),
                0 0 160px rgba(255, 255, 255, 0.3),
                0 0 240px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            color: white;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .brand-badge {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(139, 76, 246, 0.15);
            border: 1px solid rgba(139, 76, 246, 0.3);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        body.theme-classicfm .brand-badge {
            background: rgba(220, 20, 60, 0.15);
            border-color: rgba(255, 215, 0, 0.4);
            color: var(--text-secondary);
        }

        body.theme-reprezent .brand-badge {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            color: var(--text-secondary);
        }

        .logo-container {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .logo-container img {
            max-height: 80px;
            max-width: 100%;
            object-fit: contain;
        }

        body.theme-classicfm .logo-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 12px 24px;
        }

        body.theme-reprezent .logo-container {
            background: rgba(31, 30, 30, 0.95);
            border-radius: 12px;
            padding: 12px 24px;
        }

        .tagline {
            font-size: 13px;
            color: var(--text-secondary);
            opacity: 0.8;
            font-weight: 500;
        }

        .now-playing {
            text-align: center;
            padding: 32px 28px;
            border-radius: 20px;
            margin-bottom: 32px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(139, 76, 246, 0.08);
            border: 1px solid rgba(139, 76, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        body.no-selection .now-playing {
            background: rgba(139, 76, 246, 0.08);
            border-color: rgba(139, 76, 246, 0.2);
            color: var(--text-primary);
        }

        .now-playing.playing {
            background: rgba(139, 76, 246, 0.15);
            border-color: rgba(139, 76, 246, 0.4);
            box-shadow: 0 8px 32px rgba(139, 76, 246, 0.2);
        }

        body.theme-classicfm .now-playing {
            background: rgba(220, 20, 60, 0.12);
            border-color: rgba(255, 215, 0, 0.3);
            color: #ffffff;
        }

        body.theme-classicfm .now-playing.playing {
            background: rgba(220, 20, 60, 0.2);
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 0 8px 32px rgba(220, 20, 60, 0.3);
        }

        body.theme-reprezent .now-playing {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        body.theme-reprezent .now-playing.playing {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(255, 255, 255, 0.2);
        }

        .now-playing-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .track-info {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.4;
        }

        .track-artist {
            font-size: 15px;
            opacity: 0.9;
            margin-top: 6px;
            font-weight: 500;
        }

        .station-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 28px;
        }

        .station-card {
            padding: 0;
            border: 1px solid rgba(139, 76, 246, 0.2);
            background: rgba(139, 76, 246, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 14px;
            position: relative;
        }

        .station-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 76, 246, 0.4);
            background: rgba(139, 76, 246, 0.1);
            box-shadow: 0 12px 40px rgba(139, 76, 246, 0.2);
        }

        .station-card.active {
            border-color: rgba(139, 76, 246, 0.6);
            background: rgba(139, 76, 246, 0.15);
            box-shadow: 0 12px 40px rgba(139, 76, 246, 0.3);
        }

        .station-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, rgba(139, 76, 246, 0.8), rgba(139, 76, 246, 0.4));
        }

        body.theme-classicfm .station-card[data-station="classicfm"] {
            border-color: rgba(255, 215, 0, 0.3);
            background: rgba(220, 20, 60, 0.1);
        }

        body.theme-classicfm .station-card[data-station="classicfm"]:hover {
            border-color: rgba(255, 215, 0, 0.5);
            background: rgba(220, 20, 60, 0.15);
            box-shadow: 0 12px 40px rgba(220, 20, 60, 0.3);
        }

        body.theme-classicfm .station-card[data-station="classicfm"].active {
            border-color: rgba(255, 215, 0, 0.6);
            background: rgba(220, 20, 60, 0.2);
            box-shadow: 0 12px 40px rgba(220, 20, 60, 0.4);
        }

        body.theme-classicfm .station-card[data-station="classicfm"].active::before {
            background: linear-gradient(90deg, #FFD700, #DC143C);
        }

        body.theme-reprezent .station-card[data-station="reprezent"] {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        body.theme-reprezent .station-card[data-station="reprezent"]:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 12px 40px rgba(255, 255, 255, 0.2);
        }

        body.theme-reprezent .station-card[data-station="reprezent"].active {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 12px 40px rgba(255, 255, 255, 0.3);
        }

        body.theme-reprezent .station-card[data-station="reprezent"].active::before {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
        }

        .station-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .station-subtitle {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            opacity: 0.8;
            margin-top: 6px;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stop-btn,
        .custom-btn {
            flex: 1;
            padding: 18px;
            border: 1px solid rgba(139, 76, 246, 0.3);
            background: rgba(139, 76, 246, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-primary);
        }

        .stop-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stop-btn:not(:disabled):hover,
        .custom-btn:hover {
            transform: translateY(-2px);
            border-color: rgba(139, 76, 246, 0.5);
            background: rgba(139, 76, 246, 0.15);
            box-shadow: 0 8px 24px rgba(139, 76, 246, 0.2);
        }

        body.theme-classicfm .stop-btn:not(:disabled),
        body.theme-classicfm .custom-btn {
            border-color: rgba(255, 215, 0, 0.3);
            background: rgba(220, 20, 60, 0.08);
        }

        body.theme-classicfm .stop-btn:not(:disabled):hover,
        body.theme-classicfm .custom-btn:hover {
            border-color: rgba(255, 215, 0, 0.5);
            background: rgba(220, 20, 60, 0.15);
            box-shadow: 0 8px 24px rgba(220, 20, 60, 0.2);
        }

        body.theme-reprezent .stop-btn:not(:disabled),
        body.theme-reprezent .custom-btn {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        body.theme-reprezent .stop-btn:not(:disabled):hover,
        body.theme-reprezent .custom-btn:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 24px rgba(255, 255, 255, 0.2);
        }

        .custom-btn.active {
            border-color: rgba(139, 76, 246, 0.5);
            background: rgba(139, 76, 246, 0.15);
        }

        body.theme-classicfm .custom-btn.active {
            border-color: rgba(255, 215, 0, 0.5);
            background: rgba(220, 20, 60, 0.15);
        }

        body.theme-reprezent .custom-btn.active {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 18px 22px;
            background: rgba(139, 76, 246, 0.08);
            border: 1px solid rgba(139, 76, 246, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            margin-bottom: 24px;
        }

        body.theme-classicfm .volume-control {
            background: rgba(220, 20, 60, 0.08);
            border-color: rgba(255, 215, 0, 0.3);
        }

        body.theme-reprezent .volume-control {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .volume-icon {
            font-size: 20px;
        }

        .volume-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(139, 76, 246, 0.15);
            border-radius: 3px;
            outline: none;
        }

        body.theme-classicfm .volume-slider {
            background: rgba(220, 20, 60, 0.2);
        }

        body.theme-reprezent .volume-slider {
            background: rgba(255, 255, 255, 0.15);
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        body.theme-classicfm .volume-slider::-webkit-slider-thumb {
            background: #DC143C;
        }

        body.theme-reprezent .volume-slider::-webkit-slider-thumb {
            background: #ffffff;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        body.theme-classicfm .volume-slider::-moz-range-thumb {
            background: #DC143C;
        }

        body.theme-reprezent .volume-slider::-moz-range-thumb {
            background: #ffffff;
        }

        .volume-value {
            min-width: 45px;
            text-align: right;
            font-weight: 700;
            font-size: 13px;
            color: var(--text-primary);
        }

        .custom-stream {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
            opacity: 0;
        }

        .custom-stream.visible {
            max-height: 200px;
            opacity: 1;
            margin-bottom: 20px;
        }

        .custom-stream-input {
            width: 100%;
            padding: 16px 18px;
            border: 1px solid rgba(139, 76, 246, 0.3);
            background: rgba(139, 76, 246, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .custom-stream-input:focus {
            outline: none;
            border-color: rgba(139, 76, 246, 0.6);
            background: rgba(139, 76, 246, 0.1);
            box-shadow: 0 4px 16px rgba(139, 76, 246, 0.15);
        }

        body.theme-classicfm .custom-stream-input {
            border-color: rgba(255, 215, 0, 0.3);
            background: rgba(220, 20, 60, 0.05);
        }

        body.theme-classicfm .custom-stream-input:focus {
            border-color: rgba(255, 215, 0, 0.6);
            background: rgba(220, 20, 60, 0.1);
            box-shadow: 0 4px 16px rgba(220, 20, 60, 0.15);
        }

        body.theme-reprezent .custom-stream-input {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        body.theme-reprezent .custom-stream-input:focus {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.15);
        }

        .custom-stream-btn {
            margin-top: 12px;
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(139, 76, 246, 0.4);
            border-radius: 12px;
            background: rgba(139, 76, 246, 0.2);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .custom-stream-btn:hover {
            transform: translateY(-2px);
            border-color: rgba(139, 76, 246, 0.6);
            background: rgba(139, 76, 246, 0.3);
            box-shadow: 0 8px 24px rgba(139, 76, 246, 0.25);
        }

        body.theme-classicfm .custom-stream-btn {
            border-color: rgba(255, 215, 0, 0.4);
            background: rgba(220, 20, 60, 0.2);
        }

        body.theme-classicfm .custom-stream-btn:hover {
            border-color: rgba(255, 215, 0, 0.6);
            background: rgba(220, 20, 60, 0.3);
            box-shadow: 0 8px 24px rgba(220, 20, 60, 0.25);
        }

        body.theme-reprezent .custom-stream-btn {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
        }

        body.theme-reprezent .custom-stream-btn:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 24px rgba(255, 255, 255, 0.25);
        }

        .status-bar {
            text-align: center;
            padding: 12px;
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            display: inline-block;
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: rgba(139, 76, 246, 0.4);
            margin-right: 8px;
            transition: all 0.3s ease;
        }

        .status-bar.playing .status-dot {
            background: #48bb78;
            box-shadow: 0 0 8px rgba(72, 187, 120, 0.6);
            animation: pulse-dot 1.5s ease-in-out infinite;
        }

        body.theme-classicfm .status-bar.playing .status-dot {
            background: #FFD700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }

        body.theme-reprezent .status-bar.playing .status-dot {
            background: #ffffff;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
    </style>
</head>
<body class="no-selection">
    <div class="player-container">
        <div class="header">
            <div class="brand-badge" id="brandBadge">Radio Player</div>
            <div class="logo-container" id="logoContainer">
                <div style="color: var(--text-primary); font-size: 40px; font-weight: 900;">RADIO</div>
            </div>
            <div class="tagline" id="tagline">Select a station to begin</div>
        </div>

        <div class="now-playing" id="nowPlaying">
            <div class="now-playing-label">NOW PLAYING</div>
            <div class="track-info" id="trackInfo">Select a station to begin</div>
            <div class="track-artist" id="trackArtist"></div>
        </div>

        <div class="station-grid">
            <button class="station-card" data-station="classicfm" data-url="https://media-ice.musicradio.com/ClassicFMMP3" data-name="Classic FM" data-tagline="The World's Greatest Music">
                <div class="station-title">Classic FM</div>
                <div class="station-subtitle">107.0 FM</div>
            </button>

            <button class="station-card" data-station="reprezent" data-url="https://radio.canstream.co.uk:8022/live.mp3" data-url-alt="http://radio.canstream.co.uk:8022/live.mp3" data-name="Reprezent 107.3 FM" data-tagline="Voice of Young London">
                <div class="station-title">Reprezent</div>
                <div class="station-subtitle">107.3 FM</div>
            </button>
        </div>

        <div class="controls">
            <button class="stop-btn" id="stopBtn" disabled>‚èπ STOP</button>
            <button class="custom-btn" id="customBtn">+ CUSTOM</button>
        </div>

        <div class="custom-stream" id="customStream">
            <input
                type="text"
                class="custom-stream-input"
                id="customStreamInput"
                placeholder="Enter stream URL (MP3/AAC)"
            >
            <button class="custom-stream-btn" id="playCustomBtn">‚ñ∂ PLAY CUSTOM STREAM</button>
        </div>

        <div class="volume-control">
            <span class="volume-icon">üîä</span>
            <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
            <span class="volume-value" id="volumeValue">80%</span>
        </div>

        <div class="status-bar" id="statusBar">
            <span class="status-dot"></span>
            <span id="statusText">Ready</span>
        </div>
    </div>

    <script>
        // v3.3 - Correct Reprezent Branding (White/Black)

        let audio = null;
        let metadataInterval = null;
        let currentStationId = '';
        let currentStationName = '';

        const stationCards = document.querySelectorAll('.station-card');
        const brandBadge = document.getElementById('brandBadge');
        const tagline = document.getElementById('tagline');
        const stopBtn = document.getElementById('stopBtn');
        const customBtn = document.getElementById('customBtn');
        const customStream = document.getElementById('customStream');
        const customStreamInput = document.getElementById('customStreamInput');
        const playCustomBtn = document.getElementById('playCustomBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const statusBar = document.getElementById('statusBar');
        const statusText = document.getElementById('statusText');
        const nowPlaying = document.getElementById('nowPlaying');
        const trackInfo = document.getElementById('trackInfo');
        const trackArtist = document.getElementById('trackArtist');
        const logoContainer = document.getElementById('logoContainer');

        // Station card clicks
        stationCards.forEach(card => {
            card.addEventListener('click', () => {
                const stationId = card.getAttribute('data-station');
                const url = card.getAttribute('data-url');
                const urlAlt = card.getAttribute('data-url-alt');
                const name = card.getAttribute('data-name');
                const stationTagline = card.getAttribute('data-tagline');

                currentStationId = stationId;
                currentStationName = name;

                // Update theme
                document.body.className = `theme-${stationId}`;

                // Update active state
                stationCards.forEach(c => c.classList.remove('active'));
                card.classList.add('active');

                // Update branding
                updateBranding(stationId, name, stationTagline);

                // Play station with fallback
                playStream(url, urlAlt);

                // Hide custom stream
                customStream.classList.remove('visible');
                customBtn.classList.remove('active');
            });
        });

        // Stop button
        stopBtn.addEventListener('click', () => {
            stopStream();
        });

        // Custom stream toggle
        customBtn.addEventListener('click', () => {
            customStream.classList.toggle('visible');
            customBtn.classList.toggle('active');
        });

        // Play custom stream
        playCustomBtn.addEventListener('click', () => {
            const url = customStreamInput.value.trim();
            if (!url) {
                updateStatus('Please enter a stream URL');
                return;
            }

            currentStationId = '';
            currentStationName = 'Custom Stream';
            document.body.className = 'no-selection';

            stationCards.forEach(c => c.classList.remove('active'));
            brandBadge.textContent = 'Custom Stream';
            logoContainer.innerHTML = '<div style="color: var(--text-primary); font-size: 40px; font-weight: 900;">CUSTOM</div>';
            tagline.textContent = 'Live Stream';

            playStream(url, null);
        });

        // Volume control
        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value;
            volumeValue.textContent = volume + '%';
            if (audio) {
                audio.volume = volume / 100;
            }
        });

        // Play stream
        function playStream(url, urlAlt = null) {
            if (audio) {
                audio.pause();
                audio = null;
            }

            stopMetadataUpdates();

            audio = new Audio(url);
            audio.volume = volumeSlider.value / 100;

            let hasTriedAlt = false;

            audio.addEventListener('playing', () => {
                updateStatus('Streaming live', true);
                stopBtn.disabled = false;

                // Prevent screen sleep
                requestWakeLock();

                if (currentStationId) {
                    startMetadataUpdates();
                } else {
                    updateNowPlaying('Live Stream', currentStationName);
                }

                // Update CarPlay and lock screen controls
                updateMediaSession(trackInfo.textContent, trackArtist.textContent, currentStationName);

                // Set playback state
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'playing';
                }
            });

            // Handle pause event
            audio.addEventListener('pause', () => {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'paused';
                }
            });

            // Handle ended event (shouldn't happen for live streams, but just in case)
            audio.addEventListener('ended', () => {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'none';
                }
            });

            audio.addEventListener('error', (e) => {
                console.error('Stream error:', e, 'URL:', url);

                // Try alternative URL if available and not tried yet
                if (urlAlt && !hasTriedAlt) {
                    hasTriedAlt = true;
                    console.log('Trying alternative URL:', urlAlt);
                    updateStatus('Trying alternative stream...', true);

                    audio = new Audio(urlAlt);
                    audio.volume = volumeSlider.value / 100;

                    // Re-attach event listeners for the new audio element
                    audio.addEventListener('playing', () => {
                        updateStatus('Streaming live', true);
                        stopBtn.disabled = false;
                        requestWakeLock();

                        if (currentStationId) {
                            startMetadataUpdates();
                        } else {
                            updateNowPlaying('Live Stream', currentStationName);
                        }

                        updateMediaSession(trackInfo.textContent, trackArtist.textContent, currentStationName);

                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'playing';
                        }
                    });

                    audio.addEventListener('pause', () => {
                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'paused';
                        }
                    });

                    audio.addEventListener('ended', () => {
                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'none';
                        }
                    });

                    audio.addEventListener('error', () => {
                        stopMetadataUpdates();
                        updateStatus('Connection error - Stream may be offline');
                        updateNowPlaying('Error', 'Unable to connect to stream');
                        stopBtn.disabled = true;
                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'none';
                        }
                    });

                    audio.addEventListener('waiting', () => {
                        updateStatus('Buffering...', true);
                    });

                    audio.play().catch((err) => {
                        console.error('Alternative stream failed:', err);
                        stopMetadataUpdates();
                        updateStatus('Both streams failed');
                        stopBtn.disabled = true;
                    });
                } else {
                    stopMetadataUpdates();
                    updateStatus('Connection error - Stream may be offline');
                    updateNowPlaying('Error', 'Unable to connect to stream');
                    stopBtn.disabled = true;
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.playbackState = 'none';
                    }
                }
            });

            audio.addEventListener('waiting', () => {
                updateStatus('Buffering...', true);
            });

            updateStatus('Connecting...', true);
            audio.play().catch((err) => {
                console.error('Play failed:', err);
                // Error event will be triggered automatically
            });
        }

        // Stop stream
        function stopStream() {
            if (audio) {
                audio.pause();
                audio = null;
            }

            stopMetadataUpdates();
            releaseWakeLock();
            updateStatus('Stopped');
            updateNowPlaying('Stopped', 'Select a station to play');
            stopBtn.disabled = true;

            // Update CarPlay/lock screen state
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'none';
            }
        }

        // Update branding
        function updateBranding(stationId, name, stationTagline) {
            brandBadge.textContent = name;
            tagline.textContent = stationTagline;

            if (stationId === 'classicfm') {
                logoContainer.innerHTML = '<img src="./assets/logos/classicfm.svg" alt="Classic FM" style="max-height:80px;max-width:100%;object-fit:contain;">';
            } else if (stationId === 'reprezent') {
                logoContainer.innerHTML = '<img src="./assets/logos/reprezent.jpg" alt="Reprezent 107.3 FM" style="max-height:80px;max-width:100%;object-fit:contain;">';
            }
        }

        // Update status
        function updateStatus(message, isPlaying = false) {
            statusText.textContent = message;
            statusBar.className = 'status-bar';
            if (isPlaying) {
                statusBar.classList.add('playing');
            }
        }

        // Update now playing
        function updateNowPlaying(title, artist) {
            trackInfo.textContent = title;
            trackArtist.textContent = artist || '';

            // Update lock screen / notification controls
            if (audio && !audio.paused) {
                updateMediaSession(title, artist, currentStationName);
            }
        }

        // Metadata fetching
        async function fetchClassicFMNowPlaying() {
            try {
                // Use CORS proxy to fetch Classic FM playlist
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent('https://www.classicfm.com/radio/playlist/'), {
                    timeout: 5000
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch playlist');
                }

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Look for now-playing section
                const nowPlayingSection = doc.querySelector('.now-playing');
                if (nowPlayingSection) {
                    const h3 = nowPlayingSection.querySelector('h3');
                    const artistLink = nowPlayingSection.querySelector('p a');

                    if (h3) {
                        const title = h3.textContent.trim();
                        const artist = artistLink ? artistLink.textContent.trim() : 'Classic FM';
                        updateNowPlaying(title, artist);
                        console.log('Classic FM now playing:', title, '-', artist);
                        return;
                    }
                }
            } catch (error) {
                console.log('Classic FM metadata unavailable:', error.message);
            }
            updateNowPlaying('Live on Classic FM', 'The World\'s Greatest Music');
        }

        async function fetchReprezentNowPlaying() {
            // Note: Reprezent stream metadata may not be available due to CORS restrictions
            // Showing default message for now
            console.log('Reprezent metadata: Using default (stream metadata not accessible)');
            updateNowPlaying('Live on Reprezent', 'Voice of Young London');
        }

        function startMetadataUpdates() {
            if (metadataInterval) {
                clearInterval(metadataInterval);
            }

            fetchNowPlaying();
            metadataInterval = setInterval(fetchNowPlaying, 15000);
        }

        function stopMetadataUpdates() {
            if (metadataInterval) {
                clearInterval(metadataInterval);
                metadataInterval = null;
            }
        }

        function fetchNowPlaying() {
            if (currentStationId === 'classicfm') {
                fetchClassicFMNowPlaying();
            } else if (currentStationId === 'reprezent') {
                fetchReprezentNowPlaying();
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Enable Media Session API for lock screen and CarPlay controls
        if ('mediaSession' in navigator) {
            // Play action
            navigator.mediaSession.setActionHandler('play', async () => {
                if (audio && audio.paused) {
                    try {
                        await audio.play();
                        navigator.mediaSession.playbackState = 'playing';
                    } catch (err) {
                        console.error('Play failed:', err);
                    }
                }
            });

            // Pause action
            navigator.mediaSession.setActionHandler('pause', () => {
                if (audio && !audio.paused) {
                    audio.pause();
                    navigator.mediaSession.playbackState = 'paused';
                }
            });

            // Stop action
            navigator.mediaSession.setActionHandler('stop', () => {
                stopStream();
                navigator.mediaSession.playbackState = 'none';
            });

            // Seek backward (optional - for CarPlay)
            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                // Radio streams can't seek, so we'll just restart
                if (audio && !audio.paused) {
                    const currentTime = audio.currentTime;
                    audio.currentTime = Math.max(0, currentTime - (details.seekOffset || 10));
                }
            });

            // Seek forward (optional - for CarPlay)
            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                // Radio streams can't seek, so we'll ignore this
                console.log('Seek forward not supported for live radio');
            });

            // Previous track (cycle to other station)
            navigator.mediaSession.setActionHandler('previoustrack', () => {
                // Switch stations
                const cards = Array.from(stationCards);
                const activeCard = cards.find(c => c.classList.contains('active'));
                if (activeCard) {
                    const currentIndex = cards.indexOf(activeCard);
                    const prevCard = cards[currentIndex === 0 ? cards.length - 1 : currentIndex - 1];
                    prevCard.click();
                }
            });

            // Next track (cycle to other station)
            navigator.mediaSession.setActionHandler('nexttrack', () => {
                // Switch stations
                const cards = Array.from(stationCards);
                const activeCard = cards.find(c => c.classList.contains('active'));
                if (activeCard) {
                    const currentIndex = cards.indexOf(activeCard);
                    const nextCard = cards[(currentIndex + 1) % cards.length];
                    nextCard.click();
                }
            });
        }

        // Update media session metadata when playing (for CarPlay and lock screen)
        function updateMediaSession(title, artist, station) {
            if ('mediaSession' in navigator) {
                // Use local icon artwork for all stations
                let artworkUrl = './assets/icons/icon-192.png';
                let largeArtworkUrl = './assets/icons/icon-512.png';

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title || 'Radio Stream',
                    artist: artist || station,
                    album: station || 'Radio Player',
                    artwork: [
                        { src: artworkUrl, sizes: '96x96', type: 'image/png' },
                        { src: artworkUrl, sizes: '128x128', type: 'image/png' },
                        { src: artworkUrl, sizes: '192x192', type: 'image/png' },
                        { src: artworkUrl, sizes: '256x256', type: 'image/png' },
                        { src: largeArtworkUrl, sizes: '384x384', type: 'image/png' },
                        { src: largeArtworkUrl, sizes: '512x512', type: 'image/png' }
                    ]
                });

                // Set playback state
                if (audio && !audio.paused) {
                    navigator.mediaSession.playbackState = 'playing';
                } else {
                    navigator.mediaSession.playbackState = 'paused';
                }

                // Set position state for live streams (always at current time)
                try {
                    navigator.mediaSession.setPositionState({
                        duration: Infinity,
                        playbackRate: 1,
                        position: 0
                    });
                } catch (err) {
                    // Position state not supported, ignore
                }
            }
        }

        // Prevent iOS from sleeping while playing
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }
    </script>
</body>
</html>
