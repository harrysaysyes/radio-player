<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Radio Player</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Radio">
    <link rel="apple-touch-icon" href="./assets/icons/icon-192.png">

    <!-- Theme Colors -->
    <meta name="theme-color" content="#8B4CF6" id="theme-color-meta">
    <meta name="msapplication-TileColor" content="#8B4CF6">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Backstage Base Colors */
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --accent-primary: #8B4CF6;
            --accent-secondary: #9BF0E1;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
        }

        html {
            height: -webkit-fill-available;
        }

        /* Animated background pattern */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(circle at 20% 50%, var(--accent-primary) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, var(--accent-secondary) 0%, transparent 50%);
            opacity: 0.1;
            animation: rotate 30s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Base Theme - Backstage Inspired */
        body.no-selection {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --accent-primary: #8B4CF6;
            --accent-secondary: #9BF0E1;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
        }

        /* Classic FM Brand Theme - Deep Crimson with Gold Accents */
        body.theme-classicfm {
            background: linear-gradient(135deg, #0a0000 0%, #1a0000 30%, #2a0505 70%, #0a0000 100%);
            --bg-primary: #0a0000;
            --bg-secondary: #1a0000;
            --bg-card: #2a0505;
            --accent-primary: #FFD700;
            --accent-secondary: #FFA500;
            --text-primary: #ffffff;
            --text-secondary: #FFD700;
        }

        body.theme-classicfm::before {
            background:
                radial-gradient(circle at 20% 50%, #DC143C 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, #FFD700 0%, transparent 50%);
        }

        /* Reprezent Brand Theme - Neon Urban */
        body.theme-reprezent {
            background: linear-gradient(135deg, #000000 0%, #1F1E1E 50%, #0a0a0a 100%);
            --bg-primary: #000000;
            --bg-secondary: #1F1E1E;
            --bg-card: #2a2929;
            --accent-primary: #B8FF61;
            --accent-secondary: #76e3ce;
            --text-primary: #ffffff;
            --text-secondary: #B8FF61;
        }

        body.theme-reprezent::before {
            background:
                radial-gradient(circle at 20% 50%, #B8FF61 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, #76e3ce 0%, transparent 50%);
            opacity: 0.15;
        }

        .player-container {
            background: rgba(15, 52, 96, 0.85);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 32px;
            padding: 48px;
            --glow-intensity: 0.5;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px var(--border-color),
                0 0 100px rgba(139, 76, 246, var(--glow-intensity)),
                0 0 200px rgba(139, 76, 246, calc(var(--glow-intensity) * 0.7)),
                0 0 350px rgba(139, 76, 246, calc(var(--glow-intensity) * 0.4)),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            max-width: 700px;
            width: 100%;
            transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                        border 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
            border: 1px solid var(--border-color);
        }

        body.theme-classicfm .player-container {
            background: rgba(42, 5, 5, 0.95);
            box-shadow:
                0 30px 90px rgba(220, 20, 60, 0.4),
                0 0 0 1px rgba(255, 215, 0, 0.3),
                0 0 100px rgba(220, 20, 60, calc(var(--glow-intensity) * 0.7)),
                0 0 200px rgba(255, 215, 0, calc(var(--glow-intensity) * 0.6)),
                0 0 350px rgba(220, 20, 60, calc(var(--glow-intensity) * 0.4)),
                inset 0 1px 0 rgba(255, 215, 0, 0.1);
        }

        body.theme-reprezent .player-container {
            background: rgba(31, 30, 30, 0.95);
            box-shadow:
                0 30px 90px rgba(184, 255, 97, 0.2),
                0 0 0 1px rgba(184, 255, 97, 0.3),
                0 0 100px rgba(184, 255, 97, var(--glow-intensity)),
                0 0 200px rgba(118, 227, 206, calc(var(--glow-intensity) * 0.7)),
                0 0 350px rgba(184, 255, 97, calc(var(--glow-intensity) * 0.4)),
                inset 0 1px 0 rgba(184, 255, 97, 0.05);
            color: white;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .brand-badge {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 8px 20px;
            background: var(--border-color);
            border-radius: 100px;
            margin-bottom: 24px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--accent-secondary);
            transition: all 0.4s ease;
        }

        .logo-container {
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            transition: all 0.6s ease;
        }

        .logo-container img {
            max-height: 85px;
            max-width: 350px;
            object-fit: contain;
            filter: drop-shadow(0 4px 20px rgba(0, 0, 0, 0.3));
            transition: all 0.6s ease;
        }

        body.theme-classicfm .logo-container img {
            filter: drop-shadow(0 8px 30px rgba(255, 215, 0, 0.4));
        }

        body.theme-reprezent .logo-container img {
            filter: drop-shadow(0 8px 30px rgba(184, 255, 97, 0.5));
        }

        .tagline {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        .now-playing {
            text-align: center;
            padding: 32px;
            border-radius: 20px;
            margin-bottom: 32px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .now-playing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .now-playing.playing::before {
            opacity: 1;
        }

        body.no-selection .now-playing {
            background: linear-gradient(135deg, rgba(139, 76, 246, 0.15) 0%, rgba(155, 240, 225, 0.15) 100%);
        }

        body.theme-classicfm .now-playing {
            background: linear-gradient(135deg, rgba(220, 20, 60, 0.2) 0%, rgba(139, 0, 0, 0.15) 100%);
            border-color: rgba(255, 215, 0, 0.3);
        }

        body.theme-reprezent .now-playing {
            background: linear-gradient(135deg, rgba(184, 255, 97, 0.15) 0%, rgba(118, 227, 206, 0.15) 100%);
            border-color: rgba(184, 255, 97, 0.2);
        }

        .now-playing-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2.5px;
            opacity: 0.7;
            margin-bottom: 16px;
            font-weight: 700;
            color: var(--accent-secondary);
        }

        .track-info {
            font-size: 20px;
            font-weight: 700;
            line-height: 1.4;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .track-artist {
            font-size: 15px;
            opacity: 0.8;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .station-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .station-card {
            padding: 0;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            position: relative;
            border: 2px solid transparent;
        }

        .station-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .station-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-primary);
        }

        .station-card:hover::before {
            opacity: 1;
        }

        .station-card.active {
            transform: translateY(-4px) scale(1.05);
            box-shadow:
                0 25px 50px rgba(0, 0, 0, 0.4),
                0 0 0 3px var(--accent-primary);
            border-color: var(--accent-primary);
        }

        body.theme-classicfm .station-card.active {
            box-shadow:
                0 25px 50px rgba(220, 20, 60, 0.5),
                0 0 0 3px #FFD700;
            border-color: #FFD700;
        }

        body.theme-reprezent .station-card.active {
            box-shadow:
                0 25px 50px rgba(184, 255, 97, 0.4),
                0 0 0 3px #B8FF61;
            border-color: #B8FF61;
        }

        .station-logo {
            height: 70px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
        }

        .station-logo img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            transition: all 0.3s ease;
        }

        .station-card:hover .station-logo img {
            transform: scale(1.1);
        }

        .station-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .station-card:hover .station-name {
            color: var(--accent-primary);
        }

        .controls {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .control-btn,
        .custom-btn {
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 14px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .control-btn::before,
        .custom-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--accent-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .control-btn:hover:not(:disabled),
        .custom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-primary);
        }

        .control-btn:hover:not(:disabled)::before,
        .custom-btn:hover::before {
            opacity: 0.1;
        }

        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .custom-btn.active {
            background: rgba(139, 76, 246, 0.2);
            border-color: var(--accent-primary);
        }

        body.theme-classicfm .custom-btn.active {
            background: rgba(255, 215, 0, 0.15);
            border-color: #FFD700;
        }

        body.theme-reprezent .custom-btn.active {
            background: rgba(184, 255, 97, 0.15);
            border-color: #B8FF61;
        }

        .custom-stream {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease, margin 0.4s ease;
            opacity: 0;
        }

        .custom-stream.visible {
            max-height: 200px;
            opacity: 1;
            margin-bottom: 24px;
        }

        .custom-stream-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .custom-stream-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .custom-stream-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 0 4px rgba(139, 76, 246, 0.1);
        }

        body.theme-classicfm .custom-stream-input:focus {
            border-color: #FFD700;
            box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.15);
        }

        body.theme-reprezent .custom-stream-input:focus {
            border-color: #B8FF61;
            box-shadow: 0 0 0 4px rgba(184, 255, 97, 0.15);
        }

        .custom-stream-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .custom-stream-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 76, 246, 0.4);
        }

        body.theme-classicfm .custom-stream-btn {
            background: linear-gradient(135deg, #DC143C, #FFD700);
        }

        body.theme-reprezent .custom-stream-btn {
            background: linear-gradient(135deg, #B8FF61, #76e3ce);
            color: #000;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .volume-icon {
            font-size: 22px;
            transition: transform 0.3s ease;
        }

        .volume-control:hover .volume-icon {
            transform: scale(1.1);
        }

        .volume-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
            position: relative;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 10px rgba(139, 76, 246, 0.4);
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 20px rgba(139, 76, 246, 0.6);
        }

        body.theme-classicfm .volume-slider::-webkit-slider-thumb {
            background: #FFD700;
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4);
        }

        body.theme-classicfm .volume-slider::-webkit-slider-thumb:hover {
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6);
        }

        body.theme-reprezent .volume-slider::-webkit-slider-thumb {
            background: #B8FF61;
            box-shadow: 0 2px 10px rgba(184, 255, 97, 0.4);
        }

        body.theme-reprezent .volume-slider::-webkit-slider-thumb:hover {
            box-shadow: 0 4px 20px rgba(184, 255, 97, 0.6);
        }

        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .volume-value {
            min-width: 50px;
            text-align: right;
            font-weight: 700;
            font-size: 14px;
            color: var(--accent-primary);
        }

        .status-bar {
            text-align: center;
            padding: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .status-bar.playing .status-dot {
            background: var(--accent-primary);
            animation: pulse-dot 1.5s ease-in-out infinite;
            box-shadow: 0 0 15px var(--accent-primary);
        }

        body.theme-classicfm .status-bar.playing .status-dot {
            background: #FFD700;
            box-shadow: 0 0 15px #FFD700;
        }

        body.theme-reprezent .status-bar.playing .status-dot {
            background: #B8FF61;
            box-shadow: 0 0 15px #B8FF61;
        }

        @keyframes pulse-dot {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.3);
            }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .player-container {
                padding: 32px 24px;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .station-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="no-selection">
    <div class="player-container">
        <div class="header">
            <div class="brand-badge">
                <span>üéµ</span>
                <span id="brandBadge">Radio Player</span>
            </div>
            <div class="logo-container" id="logoContainer">
                <div style="color: var(--accent-primary); font-size: 32px; font-weight: 900; letter-spacing: -1px;">RADIO</div>
            </div>
            <div class="tagline" id="tagline">Select your station to begin</div>
        </div>

        <div class="now-playing" id="nowPlaying">
            <div class="now-playing-label">NOW PLAYING</div>
            <div class="track-info" id="trackInfo">Select a station to begin</div>
            <div class="track-artist" id="trackArtist"></div>
        </div>

        <div class="station-grid">
            <button class="station-card" data-station="classicfm" data-url="https://media-ice.musicradio.com/ClassicFMMP3" data-name="Classic FM" data-tagline="The World's Greatest Music">
                <div class="station-logo">
                    <div style='font-size:32px;font-weight:900;color:#ffffff;'>CLASSIC FM</div>
                </div>
                <div class="station-name">Classic FM</div>
            </button>

            <button class="station-card" data-station="reprezent" data-url="https://radio.canstream.co.uk:8022/live.mp3" data-url-alt="http://radio.canstream.co.uk:8022/live.mp3" data-name="Reprezent 107.3 FM" data-tagline="Voice of Young London">
                <div class="station-logo">
                    <div style='font-size:28px;font-weight:900;color:#B8FF61;'>REPREZENT</div>
                </div>
                <div class="station-name">Reprezent 107.3</div>
            </button>
        </div>

        <div class="controls">
            <button class="control-btn" id="stopBtn" disabled>‚èπ STOP</button>
            <button class="custom-btn" id="customBtn">+ CUSTOM</button>
        </div>

        <div class="custom-stream" id="customStream">
            <input
                type="text"
                class="custom-stream-input"
                id="customStreamInput"
                placeholder="Enter stream URL (MP3/AAC)"
            >
            <button class="custom-stream-btn" id="playCustomBtn">‚ñ∂ PLAY CUSTOM STREAM</button>
        </div>

        <div class="volume-control">
            <span class="volume-icon">üîä</span>
            <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
            <span class="volume-value" id="volumeValue">80%</span>
        </div>

        <div class="status-bar" id="statusBar">
            <span class="status-dot"></span>
            <span id="statusText">Ready</span>
        </div>

        <div style="text-align: center; margin-top: 16px; font-size: 10px; opacity: 0.4; color: var(--text-secondary);">
            v2.7 - Refined Pulse + Play Fix
        </div>
    </div>

    <script>
        let audio = null;
        let metadataInterval = null;
        let currentStationId = '';
        let currentStationName = '';
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let animationFrameId = null;
        let zeroFrameCount = 0; // Track frames with zero audio data
        let useFallbackMode = false; // Force fallback if CORS blocks audio

        const stationCards = document.querySelectorAll('.station-card');
        const stopBtn = document.getElementById('stopBtn');
        const customBtn = document.getElementById('customBtn');
        const customStream = document.getElementById('customStream');
        const customStreamInput = document.getElementById('customStreamInput');
        const playCustomBtn = document.getElementById('playCustomBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const statusBar = document.getElementById('statusBar');
        const statusText = document.getElementById('statusText');
        const nowPlaying = document.getElementById('nowPlaying');
        const trackInfo = document.getElementById('trackInfo');
        const trackArtist = document.getElementById('trackArtist');
        const logoContainer = document.getElementById('logoContainer');
        const brandBadge = document.getElementById('brandBadge');
        const tagline = document.getElementById('tagline');
        const themeColorMeta = document.getElementById('theme-color-meta');

        // Station button clicks
        stationCards.forEach(btn => {
            btn.addEventListener('click', () => {
                const stationId = btn.getAttribute('data-station');
                const url = btn.getAttribute('data-url');
                const urlAlt = btn.getAttribute('data-url-alt');
                const name = btn.getAttribute('data-name');
                const stationTagline = btn.getAttribute('data-tagline');

                currentStationId = stationId;
                currentStationName = name;

                // Update theme
                document.body.className = `theme-${stationId}`;

                // Update active state
                stationCards.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update branding
                updateBranding(stationId, name, stationTagline);

                // Update theme color meta tag
                updateThemeColor(stationId);

                // Play station with fallback
                playStream(url, urlAlt);

                // Hide custom stream
                customStream.classList.remove('visible');
                customBtn.classList.remove('active');
            });
        });

        // Stop button
        stopBtn.addEventListener('click', () => {
            stopStream();
        });

        // Custom stream toggle
        customBtn.addEventListener('click', () => {
            customStream.classList.toggle('visible');
            customBtn.classList.toggle('active');
        });

        // Play custom stream
        playCustomBtn.addEventListener('click', () => {
            const url = customStreamInput.value.trim();
            if (!url) {
                updateStatus('Please enter a stream URL');
                return;
            }

            currentStationId = '';
            currentStationName = 'Custom Stream';
            document.body.className = 'no-selection';

            stationCards.forEach(b => b.classList.remove('active'));
            logoContainer.innerHTML = '<div style="color: var(--accent-primary); font-size: 32px; font-weight: 900; letter-spacing: -1px;">CUSTOM</div>';
            brandBadge.textContent = 'Custom Stream';
            tagline.textContent = 'Custom URL Stream';
            updateThemeColor('');

            playStream(url, null);
        });

        // Volume control
        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value;
            volumeValue.textContent = volume + '%';
            if (audio) {
                audio.volume = volume / 100;
            }
        });

        // Update branding
        function updateBranding(stationId, name, stationTagline) {
            brandBadge.textContent = name;
            tagline.textContent = stationTagline;

            if (stationId === 'classicfm') {
                logoContainer.innerHTML = '<div style="font-size:40px;font-weight:900;color:#ffffff;">CLASSIC FM</div>';
            } else if (stationId === 'reprezent') {
                logoContainer.innerHTML = '<div style="font-size:40px;font-weight:900;color:#B8FF61;">REPREZENT</div>';
            }
        }

        // Update theme color meta tag
        function updateThemeColor(stationId) {
            if (stationId === 'classicfm') {
                themeColorMeta.setAttribute('content', '#DC143C');
            } else if (stationId === 'reprezent') {
                themeColorMeta.setAttribute('content', '#B8FF61');
            } else {
                themeColorMeta.setAttribute('content', '#8B4CF6');
            }
        }

        // Play stream
        function playStream(url, urlAlt = null) {
            console.log('üéµ playStream called with URL:', url);

            if (audio) {
                audio.pause();
                audio = null;
            }

            stopMetadataUpdates();

            audio = new Audio(url);
            audio.volume = volumeSlider.value / 100;

            let hasTriedAlt = false;

            audio.addEventListener('loadstart', () => {
                console.log('üì° Audio loading started...');
            });

            audio.addEventListener('loadeddata', () => {
                console.log('‚úÖ Audio data loaded');
            });

            audio.addEventListener('canplay', () => {
                console.log('‚ñ∂Ô∏è Audio can play');
            });

            audio.addEventListener('playing', () => {
                console.log('üé∂ PLAYING EVENT FIRED - Audio is playing!');
                updateStatus('Streaming live', true);
                stopBtn.disabled = false;
                nowPlaying.classList.add('playing');

                // Prevent screen sleep
                requestWakeLock();

                // Start audio visualization
                console.log('üé® Calling setupAudioVisualization()...');
                setupAudioVisualization();

                if (currentStationId) {
                    startMetadataUpdates();
                } else {
                    updateNowPlaying('Live Stream', currentStationName);
                }

                // Update CarPlay and lock screen controls
                updateMediaSession(trackInfo.textContent, trackArtist.textContent, currentStationName);

                // Set playback state
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'playing';
                }
            });

            // Handle pause event
            audio.addEventListener('pause', () => {
                nowPlaying.classList.remove('playing');
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'paused';
                }
            });

            // Handle ended event
            audio.addEventListener('ended', () => {
                nowPlaying.classList.remove('playing');
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.playbackState = 'none';
                }
            });

            audio.addEventListener('error', (e) => {
                console.error('Stream error:', e, 'URL:', url);

                // Try alternative URL if available and not tried yet
                if (urlAlt && !hasTriedAlt) {
                    hasTriedAlt = true;
                    console.log('Trying alternative URL:', urlAlt);
                    updateStatus('Trying alternative stream...', true);

                    audio = new Audio(urlAlt);
                    audio.volume = volumeSlider.value / 100;

                    // Re-attach event listeners for the new audio element
                    audio.addEventListener('playing', () => {
                        updateStatus('Streaming live', true);
                        stopBtn.disabled = false;
                        nowPlaying.classList.add('playing');
                        requestWakeLock();
                        setupAudioVisualization();

                        if (currentStationId) {
                            startMetadataUpdates();
                        } else {
                            updateNowPlaying('Live Stream', currentStationName);
                        }

                        updateMediaSession(trackInfo.textContent, trackArtist.textContent, currentStationName);

                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'playing';
                        }
                    });

                    audio.addEventListener('pause', () => {
                        nowPlaying.classList.remove('playing');
                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'paused';
                        }
                    });

                    audio.addEventListener('ended', () => {
                        nowPlaying.classList.remove('playing');
                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'none';
                        }
                    });

                    audio.addEventListener('error', () => {
                        stopMetadataUpdates();
                        nowPlaying.classList.remove('playing');
                        updateStatus('Connection error - Stream may be offline');
                        updateNowPlaying('Error', 'Unable to connect to stream');
                        stopBtn.disabled = true;
                        if ('mediaSession' in navigator) {
                            navigator.mediaSession.playbackState = 'none';
                        }
                    });

                    audio.addEventListener('waiting', () => {
                        updateStatus('Buffering...', true);
                    });

                    audio.play().catch((err) => {
                        console.error('Alternative stream failed:', err);
                        stopMetadataUpdates();
                        nowPlaying.classList.remove('playing');
                        updateStatus('Both streams failed');
                        stopBtn.disabled = true;
                    });
                } else {
                    stopMetadataUpdates();
                    nowPlaying.classList.remove('playing');
                    updateStatus('Connection error - Stream may be offline');
                    updateNowPlaying('Error', 'Unable to connect to stream');
                    stopBtn.disabled = true;
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.playbackState = 'none';
                    }
                }
            });

            audio.addEventListener('waiting', () => {
                updateStatus('Buffering...', true);
            });

            updateStatus('Connecting...', true);
            console.log('üöÄ Attempting to play audio...');

            // Try to play - browsers require this to be within user gesture
            audio.play()
                .then(() => {
                    console.log('‚úÖ Playback started successfully');
                })
                .catch((err) => {
                    console.warn('‚ö†Ô∏è First play attempt failed:', err.name);

                    // Immediate retry (still within user gesture window)
                    if (err.name === 'NotAllowedError' || err.name === 'NotSupportedError') {
                        console.log('üîÑ Immediate retry...');
                        audio.play()
                            .then(() => console.log('‚úÖ Retry successful'))
                            .catch((retryErr) => {
                                console.error('‚ùå Retry failed:', retryErr.name);
                                updateStatus('Click station again to start');
                            });
                    } else {
                        updateStatus('Connection error - Try again');
                    }
                });
        }

        // Stop stream
        function stopStream() {
            if (audio) {
                audio.pause();
                audio = null;
            }

            stopMetadataUpdates();
            releaseWakeLock();
            stopAudioVisualization();
            nowPlaying.classList.remove('playing');
            updateStatus('Stopped');
            updateNowPlaying('Stopped', 'Select a station to play');
            stopBtn.disabled = true;

            // Update CarPlay/lock screen state
            if ('mediaSession' in navigator) {
                navigator.mediaSession.playbackState = 'none';
            }
        }

        // Update status
        function updateStatus(message, isPlaying = false) {
            statusText.textContent = message;
            statusBar.className = 'status-bar';
            if (isPlaying) {
                statusBar.classList.add('playing');
            }
        }

        // Update now playing
        function updateNowPlaying(title, artist) {
            trackInfo.textContent = title;
            trackArtist.textContent = artist || '';

            // Update lock screen / notification controls
            if (audio && !audio.paused) {
                updateMediaSession(title, artist, currentStationName);
            }
        }

        // Metadata fetching
        async function fetchClassicFMNowPlaying() {
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent('https://www.classicfm.com/radio/playlist/'), {
                    timeout: 5000
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch playlist');
                }

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                const nowPlayingSection = doc.querySelector('.now-playing');
                if (nowPlayingSection) {
                    const h3 = nowPlayingSection.querySelector('h3');
                    const artistLink = nowPlayingSection.querySelector('p a');

                    if (h3) {
                        const title = h3.textContent.trim();
                        const artist = artistLink ? artistLink.textContent.trim() : 'Classic FM';
                        updateNowPlaying(title, artist);
                        console.log('Classic FM now playing:', title, '-', artist);
                        return;
                    }
                }
            } catch (error) {
                console.log('Classic FM metadata unavailable:', error.message);
            }
            updateNowPlaying('Live on Classic FM', 'The World\'s Greatest Music');
        }

        async function fetchReprezentNowPlaying() {
            console.log('Reprezent metadata: Using default (stream metadata not accessible)');
            updateNowPlaying('Live on Reprezent', 'Voice of Young London');
        }

        function startMetadataUpdates() {
            if (metadataInterval) {
                clearInterval(metadataInterval);
            }

            fetchNowPlaying();
            metadataInterval = setInterval(fetchNowPlaying, 15000);
        }

        function stopMetadataUpdates() {
            if (metadataInterval) {
                clearInterval(metadataInterval);
                metadataInterval = null;
            }
        }

        function fetchNowPlaying() {
            if (currentStationId === 'classicfm') {
                fetchClassicFMNowPlaying();
            } else if (currentStationId === 'reprezent') {
                fetchReprezentNowPlaying();
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Enable Media Session API for lock screen and CarPlay controls
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('play', async () => {
                if (audio && audio.paused) {
                    try {
                        await audio.play();
                        navigator.mediaSession.playbackState = 'playing';
                    } catch (err) {
                        console.error('Play failed:', err);
                    }
                }
            });

            navigator.mediaSession.setActionHandler('pause', () => {
                if (audio && !audio.paused) {
                    audio.pause();
                    navigator.mediaSession.playbackState = 'paused';
                }
            });

            navigator.mediaSession.setActionHandler('stop', () => {
                stopStream();
                navigator.mediaSession.playbackState = 'none';
            });

            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                if (audio && !audio.paused) {
                    const currentTime = audio.currentTime;
                    audio.currentTime = Math.max(0, currentTime - (details.seekOffset || 10));
                }
            });

            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                console.log('Seek forward not supported for live radio');
            });

            navigator.mediaSession.setActionHandler('previoustrack', () => {
                const buttons = Array.from(stationCards);
                const activeButton = buttons.find(b => b.classList.contains('active'));
                if (activeButton) {
                    const currentIndex = buttons.indexOf(activeButton);
                    const prevButton = buttons[currentIndex === 0 ? buttons.length - 1 : currentIndex - 1];
                    prevButton.click();
                }
            });

            navigator.mediaSession.setActionHandler('nexttrack', () => {
                const buttons = Array.from(stationCards);
                const activeButton = buttons.find(b => b.classList.contains('active'));
                if (activeButton) {
                    const currentIndex = buttons.indexOf(activeButton);
                    const nextButton = buttons[(currentIndex + 1) % buttons.length];
                    nextButton.click();
                }
            });
        }

        // Update media session metadata
        function updateMediaSession(title, artist, station) {
            if ('mediaSession' in navigator) {
                let artworkUrl = './assets/icons/icon-192.png';
                let largeArtworkUrl = './assets/icons/icon-512.png';

                if (currentStationId === 'classicfm') {
                    artworkUrl = './assets/icons/icon-192.png';
                    largeArtworkUrl = './assets/icons/icon-512.png';
                } else if (currentStationId === 'reprezent') {
                    artworkUrl = './assets/icons/icon-192.png';
                    largeArtworkUrl = './assets/icons/icon-512.png';
                }

                navigator.mediaSession.metadata = new MediaMetadata({
                    title: title || 'Radio Stream',
                    artist: artist || station,
                    album: station || 'Radio Player',
                    artwork: [
                        { src: artworkUrl, sizes: '96x96', type: 'image/png' },
                        { src: artworkUrl, sizes: '128x128', type: 'image/png' },
                        { src: artworkUrl, sizes: '192x192', type: 'image/png' },
                        { src: artworkUrl, sizes: '256x256', type: 'image/png' },
                        { src: largeArtworkUrl, sizes: '384x384', type: 'image/png' },
                        { src: largeArtworkUrl, sizes: '512x512', type: 'image/png' }
                    ]
                });

                if (audio && !audio.paused) {
                    navigator.mediaSession.playbackState = 'playing';
                } else {
                    navigator.mediaSession.playbackState = 'paused';
                }

                try {
                    navigator.mediaSession.setPositionState({
                        duration: Infinity,
                        playbackRate: 1,
                        position: 0
                    });
                } catch (err) {
                    // Position state not supported
                }
            }
        }

        // Prevent iOS from sleeping while playing
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) {
                console.log('Wake Lock error:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        // Audio visualization - pulse glow with music
        function setupAudioVisualization() {
            console.log('üé® setupAudioVisualization() called');
            console.log('   - audio exists:', !!audio);
            console.log('   - audio.src:', audio?.src);
            console.log('   - audio.paused:', audio?.paused);
            console.log('   - useFallbackMode:', useFallbackMode);

            if (!audio || !audio.src) {
                console.warn('‚ö†Ô∏è Cannot setup visualization: no audio or no src');
                return;
            }

            // If we've already detected CORS blocking, skip Web Audio API
            if (useFallbackMode) {
                console.log('üåä Using fallback mode (CORS detected previously)');
                visualizeFallback();
                return;
            }

            // Try real audio analysis first
            try {
                console.log('üî¨ Attempting Web Audio API setup...');

                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('‚úÖ AudioContext created:', audioContext.state);
                }

                if (!analyser) {
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    const bufferLength = analyser.frequencyBinCount;
                    dataArray = new Uint8Array(bufferLength);

                    const source = audioContext.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);

                    console.log('‚úÖ Analyser created, FFT size:', analyser.fftSize);
                }

                console.log('‚úÖ Audio visualization: Real-time audio analysis active');
                console.log('üìä Monitoring for CORS blocking (will auto-switch to fallback if detected)...');
                zeroFrameCount = 0; // Reset counter
                visualize();
                return;
            } catch (err) {
                // CORS blocks audio analysis for cross-origin streams
                console.log('‚ö†Ô∏è Audio visualization: CORS blocked at setup, using simulated pulse effect');
                console.log('   Error name:', err.name);
                console.log('   Error message:', err.message);
                useFallbackMode = true;
            }

            // Fallback: Simulated rhythmic pulse effect
            console.log('üåä Starting fallback pulse visualization...');
            visualizeFallback();
        }

        function visualize() {
            if (!analyser || !dataArray) {
                console.warn('‚ö†Ô∏è visualize() called but no analyser/dataArray');
                return;
            }

            analyser.getByteFrequencyData(dataArray);

            let sum = 0;
            const focusRange = Math.floor(dataArray.length * 0.3);
            for (let i = 0; i < focusRange; i++) {
                sum += dataArray[i];
            }
            const average = sum / focusRange;

            // Detect if CORS is blocking audio data (all zeros)
            if (average === 0) {
                zeroFrameCount++;

                // After 30 frames (~0.5 seconds) of zeros, switch to fallback
                if (zeroFrameCount >= 30 && !useFallbackMode) {
                    console.warn('üö´ CORS detected: 30 frames of zero audio data');
                    console.log('üîÑ Switching to fallback pulse mode...');
                    useFallbackMode = true;

                    // Cancel this animation loop
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }

                    // Start fallback mode
                    visualizeFallback();
                    return;
                }
            } else {
                zeroFrameCount = 0; // Reset if we get actual data
            }

            animationFrameId = requestAnimationFrame(visualize);

            const intensity = 0.4 + (average / 255) * 1.4;

            const playerContainer = document.querySelector('.player-container');
            if (playerContainer) {
                playerContainer.style.setProperty('--glow-intensity', intensity);

                // Log every 60 frames (approx 1 second)
                if (Math.random() < 0.016) {
                    console.log(`üéµ Real audio analysis - intensity: ${intensity.toFixed(2)}, avg: ${average.toFixed(0)}, zeros: ${zeroFrameCount}`);
                }
            }
        }

        // Fallback: Simulated rhythmic pulse (when CORS blocks real audio analysis)
        function visualizeFallback() {
            console.log('üåä visualizeFallback() started');
            let startTime = Date.now();
            let frameCount = 0;

            function pulse() {
                if (!audio || audio.paused) {
                    console.log('‚è∏Ô∏è Pulse stopped - audio paused or missing');
                    return;
                }

                animationFrameId = requestAnimationFrame(pulse);
                frameCount++;

                const elapsed = (Date.now() - startTime) / 1000;

                // Create a rhythmic pulse pattern (simulates music beats)
                // Different pulse patterns for different stations
                let beat1, beat2, beat3, intensity;

                if (currentStationId === 'classicfm') {
                    // Classic FM: Slower, more refined pulse for classical music
                    beat1 = Math.sin(elapsed * 1.5) * 0.5 + 0.5;   // Slow main beat (1.5 Hz ~= 90 BPM)
                    beat2 = Math.sin(elapsed * 0.75) * 0.3 + 0.3;  // Very slow secondary
                    beat3 = Math.sin(elapsed * 3.0) * 0.2 + 0.2;   // Gentle shimmer

                    // Combine for elegant, refined pulse
                    const combined = (beat1 * 0.5 + beat2 * 0.3 + beat3 * 0.2);

                    // Gentler glow intensity (0.4 to 1.2 range for refined elegance)
                    intensity = 0.4 + combined * 0.8;
                } else {
                    // Reprezent & others: Fast, energetic pulse
                    beat1 = Math.sin(elapsed * 4.0) * 0.5 + 0.5;   // Fast main beat (4.0 Hz ~= 240 BPM)
                    beat2 = Math.sin(elapsed * 2.0) * 0.3 + 0.3;   // Secondary rhythm
                    beat3 = Math.sin(elapsed * 8.0) * 0.2 + 0.2;   // Very fast shimmer

                    // Combine for natural-feeling pulse
                    const combined = (beat1 * 0.5 + beat2 * 0.3 + beat3 * 0.2);

                    // Dramatic glow intensity (0.3 to 2.2 range for energy)
                    intensity = 0.3 + combined * 1.9;
                }

                const playerContainer = document.querySelector('.player-container');
                if (playerContainer) {
                    playerContainer.style.setProperty('--glow-intensity', intensity);

                    // Log every 60 frames (approx 1 second)
                    if (frameCount % 60 === 0) {
                        console.log(`üí´ Fallback pulse - frame: ${frameCount}, intensity: ${intensity.toFixed(2)}, elapsed: ${elapsed.toFixed(1)}s`);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Could not find .player-container element!');
                }
            }

            console.log('üöÄ Starting pulse animation loop...');
            pulse();
        }

        function stopAudioVisualization() {
            console.log('‚èπÔ∏è stopAudioVisualization() called');

            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                console.log('   ‚úÖ Animation frame cancelled');
            }

            // Reset fallback mode flag for next play
            // (in case user switches to a stream without CORS issues)
            useFallbackMode = false;
            zeroFrameCount = 0;
            console.log('   ‚úÖ Fallback mode reset');

            const playerContainer = document.querySelector('.player-container');
            if (playerContainer) {
                playerContainer.style.setProperty('--glow-intensity', '0.4');
                console.log('   ‚úÖ Glow intensity reset to 0.4');
            }
        }
    </script>
</body>
</html>
